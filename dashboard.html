<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Dimonds Scheduler</title>
<style>
  :root{--bg:#071229;--card:#07122a;--accent:#7c5cff;--muted:#9fb0d6}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#071229,#031227);color:#eaf4ff;padding:20px}
  .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:20px}
  .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .btn{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#4da6ff);cursor:pointer;color:#041018;font-weight:700}
  .small{color:var(--muted);font-size:13px}
  .availability{display:grid;gap:8px;margin-top:8px}
  .av-row{display:flex;gap:8px;align-items:center}
  label{font-size:13px;color:var(--muted)}
  input,select{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf4ff}
  .book-list{margin-top:10px;display:grid;gap:10px}
  .booking{padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted)}
  @media (max-width:980px){.container{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div>
          <h3 id="meName" style="margin:0">Your Dashboard</h3>
          <div class="small" id="meEmail">your email</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="toBooking">Open public booking page</button>
          <button class="btn" id="logout">Log out</button>
        </div>
      </header>
 
      <section>
        <h4 style="margin:0 0 6px 0">Availability</h4>
        <div class="small">Add weekly availability windows. These control which days/time ranges visitors see on your booking page.</div>
 
        <div style="margin-top:10px;display:grid;gap:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <label style="width:80px" for="weekday">Weekday</label>
            <select id="weekday">
              <option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option>
              <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
            </select>
            <label style="width:60px">From</label>
            <input id="from" type="time" value="09:00" />
            <label style="width:40px">To</label>
            <input id="to" type="time" value="17:00" />
            <button class="btn" id="addAvail">Add</button>
          </div>
 
          <div id="availList" class="availability"></div>
        </div>
 
        <div style="margin-top:18px">
          <label>Default slot length (minutes)</label>
          <select id="slotLen" style="width:110px;margin-top:6px">
            <option>15</option><option selected>30</option><option>45</option><option>60</option>
          </select>
        </div>
 
        <div style="margin-top:18px">
          <h4 style="margin:0 0 6px 0">Bookings</h4>
          <div class="small">Upcoming and past meetings. Cancel or reschedule as needed.</div>
          <div class="book-list" id="bookList"></div>
        </div>
      </section>
    </div>
 
    <aside class="card">
      <h4 style="margin:0 0 8px 0">Public link</h4>
      <div class="small">Share this URL with visitors to let them book time with you.</div>
      <div style="margin-top:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
        <div id="publicLink" style="word-break:break-all"></div>
        <button class="btn" id="copyLink" style="margin-top:10px">Copy</button>
      </div>
 
      <div style="margin-top:20px">
        <h4 style="margin:0 0 8px 0">Profile</h4>
        <label class="small">Display name</label>
        <input id="pName" style="margin-top:6px" />
        <label class="small" style="margin-top:8px">Short bio</label>
        <input id="pBio" style="margin-top:6px" />
        <button class="btn" id="saveProfile" style="margin-top:10px">Save profile</button>
      </div>
    </aside>
  </div>
 
<script>
  // Simple dashboard logic on top of localStorage demo accounts
  function loadAccounts(){ return JSON.parse(localStorage.getItem('ds_accounts')||'[]'); }
  function saveAccounts(list){ localStorage.setItem('ds_accounts', JSON.stringify(list)); }
  let currentEmail = localStorage.getItem('ds_current_user');
  if(!currentEmail){ alert('No user logged in. Redirecting to home.'); location.href='index.html'; }
 
  let accounts = loadAccounts();
  let me = accounts.find(a=> a.email === currentEmail);
  if(!me){ alert('Account not found in demo storage. Redirecting to signup.'); location.href='signup.html'; }
 
  // UI refs
  document.getElementById('meName').textContent = me.name;
  document.getElementById('meEmail').textContent = me.email;
  document.getElementById('pName').value = me.name;
  document.getElementById('pBio').value = me.bio || '';
  document.getElementById('slotLen').value = me.slot || 30;
  const availList = document.getElementById('availList');
  function renderAvailability(){
    availList.innerHTML = '';
    (me.availability || []).forEach((a, idx)=>{
      const div = document.createElement('div'); div.className='av-row';
      div.innerHTML = `<div style="flex:1"><strong>${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][a.weekday]}</strong> · ${a.from} — ${a.to}</div>
                      <div style="display:flex;gap:6px"><button class="btn" data-idx="${idx}" onclick="removeAvail(event)">Remove</button></div>`;
      availList.appendChild(div);
    });
  }
  renderAvailability();
 
  function removeAvail(e){
    const idx = parseInt(e.currentTarget.dataset.idx,10);
    me.availability.splice(idx,1);
    saveBack();
    renderAvailability();
    renderBookings();
  }
 
  document.getElementById('addAvail').onclick = ()=>{
    const weekday = parseInt(document.getElementById('weekday').value,10);
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    if(!from || !to){ alert('Please choose from/to times'); return; }
    if(from >= to){ alert('End time must be after start time'); return; }
    me.availability = me.availability || [];
    me.availability.push({weekday, from, to});
    saveBack();
    renderAvailability();
    alert('Availability added.');
  };
 
  document.getElementById('saveProfile').onclick = ()=>{
    me.name = document.getElementById('pName').value.trim() || me.name;
    me.bio = document.getElementById('pBio').value.trim();
    me.slot = parseInt(document.getElementById('slotLen').value,10);
    saveBack();
    alert('Profile saved.');
    document.getElementById('meName').textContent = me.name;
  };
 
  function saveBack(){
    // save me into accounts and persist
    accounts = accounts.filter(a=> a.email !== me.email);
    accounts.push(me);
    saveAccounts(accounts);
  }
 
  document.getElementById('toBooking').onclick = ()=> {
    // open public page for this owner (schedule.html reads accounts and shows first account by default).
    // to make it easy we ensure this account is the first in the list
    accounts = loadAccounts();
    accounts = accounts.filter(a=> a.email !== me.email);
    accounts.unshift(me);
    saveAccounts(accounts);
    location.href = 'schedule.html';
  };
 
  document.getElementById('logout').onclick = ()=> {
    localStorage.removeItem('ds_current_user');
    location.href = 'index.html';
  };
 
  // Bookings view
  function renderBookings(){
    const list = document.getElementById('bookList');
    list.innerHTML = '';
    (me.bookings || []).sort((a,b)=> new Date(a.time)-new Date(b.time)).forEach((b,i)=>{
      const when = new Date(b.time);
      const el = document.createElement('div'); el.className='booking';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${b.guestName} · ${b.guestEmail}</div>
                        <div class="muted" style="margin-top:6px">${when.toLocaleString()} · ${b.notes||''}</div>`;
      const right = document.createElement('div');
      const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel';
      cancel.onclick = ()=> {
        if(!confirm('Cancel this booking?')) return;
        me.bookings = me.bookings.filter(x=> x.id !== b.id);
        saveBack();
        renderBookings();
        alert('Booking cancelled.');
      };
      const res = document.createElement('button'); res.className='btn'; res.style.marginLeft='8px'; res.textContent='Reschedule';
      res.onclick = ()=> {
        const newISO = prompt('Enter new time for booking in ISO format (e.g. 2025-09-12T14:00:00):', b.time);
        if(!newISO) return;
        const nd = new Date(newISO);
        if(isNaN(nd)) { alert('Invalid date'); return; }
        // check double booking
        if((me.bookings||[]).some(x=> x.id !== b.id && new Date(x.time).getTime()===nd.getTime())){
          alert('That time is already booked.');
          return;
        }
        b.time = nd.toISOString();
        saveBack();
        renderBookings();
        alert('Rescheduled.');
      };
      right.appendChild(cancel); right.appendChild(res);
      el.appendChild(left); el.appendChild(right);
      list.appendChild(el);
    });
    if((me.bookings||[]).length===0) list.innerHTML = '<div class="muted">No bookings yet.</div>';
  }
  renderBookings();
 
  // Public link & copy
  const link = location.origin + location.pathname.replace(/[^\/]*$/,'') + 'schedule.html';
  document.getElementById('publicLink').textContent = link + '#owner=' + encodeURIComponent(me.email);
  document.getElementById('copyLink').onclick = ()=>{
    navigator.clipboard && navigator.clipboard.writeText(document.getElementById('publicLink').textContent)
      .then(()=> alert('Link copied to clipboard.'))
      .catch(()=> prompt('Copy the link manually:', document.getElementById('publicLink').textContent));
  };
 
  // ensure slot length UI change also saved
  document.getElementById('slotLen').onchange = ()=> {
    me.slot = parseInt(document.getElementById('slotLen').value,10);
    saveBack();
  };
</script>
</body>
</html>
